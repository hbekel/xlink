<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Xlink C64 Data Transfer and Control System</title>
</head>

<body>

<h1>Xlink &ndash; C64 Data Transfer and Control System </h1>

<h2>Overview</h2>

<p>Xlink is a data transfer and control system for the Commodore 64.</p>

<p>The Commodore 64 is connected to a PC via a via a custom
build <a href="#usb-adapter">USB adapter</a> or a
simple <a href="#parallel-port-cable">parallel port cable</a>.
A <a href="#client-documentation">command-line client</a> is used on
the PC to transfer data to and from C64 memory, run programs on the
C64, write or read from an attached disk drive or to initiate a
hardware reset.</p>

<p>An interrupt-driven server on the Commode 64 listens to and
executes the commands send by the client. The server can be
temporarily loaded on the C64, or it can be permanently installed
using a customized kernal rom. The latter has the advantage of being
instantly available after power-up or reset, which makes the Xlink
system well suited for fast and easy cross development using a PC and
a real Commodore 64.</p>

<p>The implementation of the underlying functionality is distributed
as a <a href="#library-documentation">shared library</a>, making the
functionality provided by Xlink readily available for use in other
programs.</p>

<p>The Xlink client software and library is supported under Linux and
Windows.</p>

<h2>Hardware</h2>

<h3>USB Adapters</h3>

<p>There are two versions of the USB Adapter. The simple version is
implemented using the V-USB Library on an ATMega8-16. The advantage is
that the microcontroller is available as a DIP package, making the
adapter trivial to build on a perfboard. The downside is that the
resulting adapter is a low-speed USB device and thus transfer rates
are limited to about 8kb/sec.</p>

<p>The advanced version implements a full-speed USB 2.0 device using
Dean Cameras LUFA library on an at90usb162 chip, allowing maximum
transfer rates up to about 20kb/sec (This is as fast as the C64 can
shove the data into memory). Unfortunately the chip is only available
in SMD packaging (TQFP-32), and thus building the adapter requires a
proper pcb and some soldering skill.</p>

<p><a href="images/adapter-schematics.pdf">Schematics</a> for both versions
as well as a pcb layout for the advanced version are included in the
source distribution.</p>

<h3>Parallel Port Cable</h3>

<p>This is a simple 8-bit parallel transfer cable connecting the PC
Parallel Port to the C64 userport:</p>

<table border="1">
<thead>
<tr>
<th>PC Parallel Port  </th>
<th> C64 Userport</th>
</tr>
</thead>
<tbody>
<tr>
<td>GND (18-25)     </td>
<td> GND (1, 12, A, N)</td>
</tr>
<tr>
<td>D0 (2)  </td>
<td> PB0 (C)</td>
</tr>
<tr>
<td>D1 (3)  </td>
<td> PB1 (D)</td>
</tr>
<tr>
<td>D2 (4)  </td>
<td> PB2 (E)</td>
</tr>
<tr>
<td>D3 (5)  </td>
<td> PB3 (F)</td>
</tr>
<tr>
<td>D4 (6)  </td>
<td> PB4 (H)</td>
</tr>
<tr>
<td>D5 (7)  </td>
<td> PB5 (J)</td>
</tr>
<tr>
<td>D6 (8)  </td>
<td> PB6 (K)</td>
</tr>
<tr>
<td>D7 (9)  </td>
<td> PB7 (L)</td>
</tr>
<tr>
<td>BUSY (11) </td>
<td> PA2 (M)</td>
</tr>
<tr>
<td>STROBE (1) </td>
<td> /FLAG2 (B)</td>
</tr>
</tbody>
</table>


<p>A shielded cable is recommended. The cable shield should be
connected to ground on both sides. A 0.1uF capacitor between shield
and ground at the c64 side can also help to reduce noise. Improper
shielding will most likely cause transfer errors.</p>

<p><strong>WARNING</strong>:</p>

<p>There is no electrical protection of any kind. The parallel port
pins are directly connected to port B of CIA2.</p>

<p><strong>Always power down both the PC and C64 before
inserting/removing the cable. Turn off the C64 during boot, reboot or
shutdown of the PC.</strong></p>

<h4>Reset Circuit</h4>

<p>This circuit is required for the parallel port cable in order to
perform a hardware reset at the C64 userport:</p>

<p><img src="images/reset.png" alt="reset circuit schematics" /></p>

<table border="1">
<thead>
<tr>
<th>Line </th>
<th>  Port </th>
<th> Pin</th>
</tr>
</thead>
<tbody>
<tr>
<td>INIT </td>
<td> Parallel Port </td>
<td> 16</td>
</tr>
<tr>
<td>RESET </td>
<td> Userport </td>
<td> 3</td>
</tr>
<tr>
<td>VCC </td>
<td> Userport </td>
<td> 2</td>
</tr>
<tr>
<td>GND </td>
<td> Userport </td>
<td> 1, 12, A, N</td>
</tr>
</tbody>
</table>


<p><strong>NOTE</strong>: The above circuit holds the C64 RESET line
low as long as the parallel port INIT line is held low. The parallel
port lines themselves may have been left in an unknown/random state
after the PC wakes up from suspend or after the port has been accessed
by another program. This means that if the INIT line happens to be
permanently low, the C64 will remain in a state of permanent reset and
appear frozen or even dead (showing just a black screen after power
up). In this case running <code>xlink reset</code> will bring the
parallel port lines back to a defined state and the C64 will resume
operation.</p>

<h2>Software</h2>

<h3>Downloads</h3>

<h4>Source distribution</h4>

<ul>
<li>xlink-1.0.tar.gz (source package,
see <a href="#building-from-source">Building from Source</a>)</li>
</ul>


<h4>Firmware</h4>

<ul>
<li>Firmware for the ATMega8</li>
<li>Firmware for the at90usb162</li>
</ul>


<h4>Linux Binaries</h4>

<h4>Windows Binaries</h4>

<ul>
<li>Windows Installer</li>
<li>Libusb-1.0 (required)</li>
<li>Inpout32.dll (optional, required for parallel port access)</li>
</ul>


<h3>Installation</h3>

<h4>Firmware</h4>

<h4>Client</h4>

<h4>Server</h4>

<hr />

<h5>Manually bootstrapping the server</h5>

<p>If you have no way to transfer the ram-based server program to
your C64 you can simply type in the following program:</p>

<pre><code>10 print"please wait...":print
20 d=12288:s=184:c=0:l=1000:m=0
30 for i=0 to s-1:for k=0 to 7
40 read v:poke d+i+k,v:c=c+v:next k
50 read v:if c&lt;&gt;v then print"data checksum error on line";l:end
60 c=0:l=l+1:i=i+7:nexti
70 print"on your pc, please run":print
80 print"xlink server xlink.prg load xlink.prg":print
90 print"then save the server:":print
100 print"save"chr$(34)"xlink"chr$(34)",8"chr$(145)
110 sys 12288
120 end
1000 data 76,58,48,173,13,221,41,16,646
1001 data 240,249,174,1,221,173,0,221,1279
1002 data 73,4,141,0,221,96,141,1,677
1003 data 221,173,0,221,73,4,141,0,833
1004 data 221,173,13,221,41,16,240,249,1174
1005 data 96,173,0,221,73,4,141,0,708
1006 data 221,96,173,13,221,41,16,240,1021
1007 data 249,96,169,0,141,3,221,173,1052
1008 data 2,221,9,4,141,2,221,173,773
1009 data 13,221,120,32,50,48,172,1,657
1010 data 221,32,41,48,192,1,208,243,986
1011 data 32,95,48,88,76,128,164,169,800
1012 data 11,141,17,208,32,148,48,160,765
1013 data 0,32,50,48,173,1,221,145,670
1014 data 193,32,41,48,230,193,208,2,947
1015 data 230,194,165,194,197,196,208,233,1617
1016 data 165,193,197,195,208,227,165,195,1545
1017 data 133,45,165,196,133,46,169,27,914
1018 data 141,17,208,96,32,3,48,134,679
1019 data 254,32,3,48,134,255,32,3,761
1020 data 48,134,193,134,251,32,3,48,843
1021 data 134,194,134,252,32,3,48,134,931
1022 data 195,32,3,48,134,196,96,0,704
</code></pre>

<p>This program will first install a rudimentary server that can be
used to upload the real server program. Just follow the on-screen
instructions:</p>

<p><img src="images/bootstrap.png" alt="bootstrapping" /></p>

<h3>Building from source</h3>

<h2>Usage</h2>

<h3>Getting started</h3>

<h3>Client documentation</h3>

<pre><code>xlink 1.0 Copyright (C) 2014 Henning Bekel &lt;h.bekel@googlemail.com&gt;

Usage: xlink [&lt;opts&gt;] [&lt;command&gt; [&lt;opts&gt;] [&lt;arguments&gt;]]...

Options:
     -h, --help                    : show this help
     -q, --quiet                   : show errors only
     -v, --verbose                 : show verbose debug output
     -d, --device &lt;device&gt;         : transfer device (default: /dev/xlink)
     -a, --address &lt;start&gt;[-&lt;end&gt;] : C64 address/range (default: autodetect)
     -s, --skip &lt;n&gt;                : Skip n bytes of file
     -m, --memory                  : C64 memory config (default: 0x37)
     -b, --bank                    : C64 memory bank (unused)

Commands:
      help  [&lt;command&gt;]            : show detailed help for command
      bootloader                   : enter dfu-bootloader (USB devices only)
      benchmark                    : test/measure transfer speed

      ping                         : check if the server is available
      reset                        : reset C64 (only if using reset circuit)
      ready                        : try to make sure the server is ready
      identify                     : identify remote machine and server

      load  [&lt;opts&gt;] &lt;file&gt;        : load file into C64 memory
      save  [&lt;opts&gt;] &lt;file&gt;        : save C64 memory to file
      poke  [&lt;opts&gt;] &lt;addr&gt;,&lt;val&gt;  : poke value into C64 memory
      peek  [&lt;opts&gt;] &lt;addr&gt;        : read value from C64 memory
      jump  [&lt;opts&gt;] &lt;addr&gt;        : jump to specified address
      run   [&lt;opts&gt;] [&lt;file&gt;]      : run program, optionally load it before
      &lt;file&gt;...                    : load file(s) and run last file

      @[&lt;dos-command&gt;]             : read drive status or send dos command
      backup &lt;file&gt;                : backup disk to d64 file
      restore &lt;file&gt;               : restore d64 file to disk
      verify &lt;file&gt;                : verify disk against d64 file
</code></pre>

<h3>Library documentation</h3>

<h2>License</h2>

<pre>
          XLINK Hardware, Firmware, Client, Server and Library
        Copyright (c) 2014, Henning Bekel <h.bekel@googlemail.com>
       
                        All rights reserved.

Redistribution and use in source and binary forms, with or without
modification, are permitted provided that the following conditions are
met:

1. Redistributions of source code must retain the above copyright
   notice, this list of conditions and the following disclaimer.

2. Redistributions in binary form must reproduce the above copyright
   notice, this list of conditions and the following disclaimer in the
   documentation and/or other materials provided with the
   distribution.

THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
"AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
(INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
</pre>


<p>The USB adapter firmware is implemented using the LUFA Library 
by Dean Camera:</p>

<pre>


                       LUFA Library
             Copyright (C) Dean Camera, 2013.

          dean [at] fourwalledcubicle [dot] com
                     www.lufa-lib.org


Permission to use, copy, modify, and distribute this software and its
documentation for any purpose is hereby granted without fee, provided
that the above copyright notice appear in all copies and that both
that the copyright notice and this permission notice and warranty
disclaimer appear in supporting documentation, and that the name of
the author not be used in advertising or publicity pertaining to
distribution of the software without specific, written prior
permission.

The author disclaims all warranties with regard to this software,
including all implied warranties of merchantability and fitness.  In
no event shall the author be liable for any special, indirect or
consequential damages or any damages whatsoever resulting from loss of
use, data or profits, whether in an action of contract, negligence or
other tortious action, arising out of or in connection with the use or
performance of this software.
</pre>


<h2>Imprint</h2>

<p>&copy; 2015 Henning Bekel 
<a href="&#x6d;&#x61;&#x69;&#x6c;&#116;&#x6f;&#x3a;&#104;&#x2e;&#x62;&#x65;&#x6b;&#101;&#108;&#x40;&#103;&#x6f;&#x6f;&#103;&#x6c;&#x65;&#x6d;&#x61;&#105;&#x6c;&#46;&#99;&#x6f;&#109;">&#x68;&#x2e;&#98;&#101;&#107;&#x65;&#108;&#x40;&#103;&#x6f;&#x6f;&#x67;&#108;&#101;&#109;&#97;&#x69;&#108;&#x2e;&#99;&#111;&#109;</a>. 
All rights reserved.</p>

</body>
</html>
